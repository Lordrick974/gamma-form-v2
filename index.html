<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé® Gamma AI Generator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      max-width: 520px;
      margin: 0 auto;
    }
    
    h1 {
      color: #667eea;
      font-size: 24px;
      margin-bottom: 8px;
      text-align: center;
    }
    
    .subtitle {
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-bottom: 20px;
    }
    
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Zone d'upload */
    .upload-zone {
      border: 2px dashed #ccc;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin: 15px 0;
      transition: all 0.3s ease;
      cursor: pointer;
      background: #fafafa;
    }
    
    .upload-zone:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .upload-zone.dragover {
      border-color: #667eea;
      background: #e8edff;
      transform: scale(1.02);
    }
    
    .upload-zone.has-files {
      border-color: #28a745;
      background: #f0fff4;
    }
    
    .upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .upload-text {
      color: #666;
      font-size: 13px;
    }
    
    .upload-text strong {
      color: #667eea;
    }
    
    .file-input {
      display: none;
    }
    
    /* Liste des fichiers */
    .file-list {
      margin-top: 10px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .file-item:last-child {
      margin-bottom: 0;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }
    
    .file-icon {
      font-size: 16px;
    }
    
    .file-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #333;
    }
    
    .file-size {
      color: #888;
      font-size: 11px;
      white-space: nowrap;
    }
    
    .file-remove {
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      padding: 4px;
      font-size: 14px;
      width: auto;
      margin: 0;
    }
    
    .file-remove:hover {
      transform: scale(1.2);
      box-shadow: none;
    }
    
    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin: 15px 0;
    }
    
    select {
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.loading {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      font-size: 13px;
      display: none;
    }
    
    .result a {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white !important;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .result a:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .result-details {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      font-family: monospace;
      font-size: 11px;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
    }
    
    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
    }
    
    .quick-btn {
      flex: 1;
      padding: 8px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .quick-btn:hover {
      background: #e9ecef;
      border-color: #667eea;
    }
    
    .hint {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
      text-align: center;
    }
    
    .supported-formats {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
    }
    
    /* Progress bar */
    .progress-container {
      display: none;
      margin-top: 10px;
    }
    
    .progress-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Gamma AI Generator</h1>
    <p class="subtitle">Powered by n8n + Claude AI + Google Search</p>
    
    <textarea 
      id="prompt" 
      placeholder="D√©crivez votre pr√©sentation en fran√ßais...

Exemple : Cr√©er une pr√©sentation professionnelle sur l'intelligence artificielle en comptabilit√©. Public : Experts-comptables. Inclure des statistiques r√©centes et des exemples concrets."
    ></textarea>
    
    <!-- Zone d'upload des fichiers -->
    <div id="uploadZone" class="upload-zone" onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">üìé</div>
      <div class="upload-text">
        <strong>Cliquez</strong> ou <strong>glissez-d√©posez</strong> vos documents
      </div>
      <div class="supported-formats">PDF, DOCX, XLSX, PPTX, TXT, Images (max 10MB/fichier)</div>
      <div id="fileList" class="file-list"></div>
    </div>
    <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.png,.jpg,.jpeg,.gif,.webp">
    
    <div class="options">
  <select id="slides">
    <option value="5">5 slides</option>
    <option value="8" selected>8 slides</option>
    <option value="10">10 slides</option>
    <option value="12">12 slides</option>
    <option value="15">15 slides</option>
    <option value="20">20 slides</option>
    <option value="25">25 slides</option>
    <option value="30">30 slides</option>
    <option value="40">40 slides</option>
    <option value="50">50 slides</option>
    <option value="60">60 slides</option>
  </select>
      <select id="style">
        <option value="professionnel" selected>Professionnel</option>
        <option value="moderne">Moderne</option>
        <option value="cr√©atif">Cr√©atif</option>
        <option value="minimaliste">Minimaliste</option>
        <option value="dynamique">Dynamique</option>
      </select>
    </div>
    
    <button id="generateBtn" onclick="generatePresentation()">
      ‚ú® G√©n√©rer Pr√©sentation
    </button>
    
    <div class="quick-actions">
      <button class="quick-btn" onclick="fillExample('comptable')">
        üíº Ex. Comptable
      </button>
      <button class="quick-btn" onclick="fillExample('pitch')">
        üöÄ Ex. Pitch Deck
      </button>
      <button class="quick-btn" onclick="fillExample('formation')">
        üìö Ex. Formation
      </button>
    </div>
    
    <div id="progressContainer" class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="progressText" class="progress-text"></div>
    </div>
    
    <div id="status" class="status"></div>
    <div id="result" class="result"></div>
    
    <p class="hint">üí° Astuce : Ajoutez des documents pour enrichir votre pr√©sentation</p>
  </div>

  <script>
    const WEBHOOK_URL = 'https://n8n.srv928399.hstgr.cloud/webhook/gamma-instant';
    
    // Stockage des fichiers s√©lectionn√©s
    let selectedFiles = [];
    
    const examples = {
      comptable: "Cr√©er une pr√©sentation sur l'automatisation des processus comptables avec n8n et l'IA. Public : Experts-comptables PME. Inclure : statistiques d'efficacit√©, outils disponibles (n8n, Claude, ChatGPT), cas d'usage concrets, ROI attendu.",
      pitch: "Cr√©er un pitch deck pour une startup d'automatisation comptable par IA. Public : Investisseurs seed. Inclure : probl√®me du march√©, solution unique, traction/KPIs, business model, √©quipe, demande de financement 500K‚Ç¨.",
      formation: "Cr√©er une formation sur l'utilisation de Claude AI pour automatiser les t√¢ches comptables. Public : Comptables d√©butants en IA. Inclure : introduction √† l'IA, cas d'usage pratiques, d√©monstrations, exercices, ressources."
    };
    
    // Gestion du drag & drop
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.add('dragover');
      }, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      uploadZone.addEventListener(eventName, () => {
        uploadZone.classList.remove('dragover');
      }, false);
    });
    
    uploadZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFileSelect, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }
    
    function handleFileSelect(e) {
      const files = e.target.files;
      handleFiles(files);
    }
    
    function handleFiles(files) {
      [...files].forEach(file => {
        // V√©rifier si le fichier n'est pas d√©j√† ajout√©
        if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
          // Limite de taille : 10MB par fichier
          if (file.size > 10 * 1024 * 1024) {
            showStatus('error', `‚ö†Ô∏è "${file.name}" d√©passe 10MB`);
            return;
          }
          selectedFiles.push(file);
        }
      });
      updateFileList();
    }
    
    function updateFileList() {
      const fileList = document.getElementById('fileList');
      
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        uploadZone.classList.remove('has-files');
        return;
      }
      
      uploadZone.classList.add('has-files');
      
      fileList.innerHTML = selectedFiles.map((file, index) => `
        <div class="file-item">
          <div class="file-info">
            <span class="file-icon">${getFileIcon(file.name)}</span>
            <span class="file-name">${file.name}</span>
          </div>
          <span class="file-size">${formatFileSize(file.size)}</span>
          <button class="file-remove" onclick="removeFile(${index})">‚úï</button>
        </div>
      `).join('');
    }
    
    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFileList();
    }
    
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        pdf: 'üìï',
        doc: 'üìò', docx: 'üìò',
        xls: 'üìó', xlsx: 'üìó', csv: 'üìó',
        ppt: 'üìô', pptx: 'üìô',
        txt: 'üìÑ',
        png: 'üñºÔ∏è', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', gif: 'üñºÔ∏è', webp: 'üñºÔ∏è'
      };
      return icons[ext] || 'üìé';
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function fillExample(type) {
      document.getElementById('prompt').value = examples[type];
    }
    
    // Convertir un fichier en base64 (SANS le pr√©fixe data:...)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          // Extraire UNIQUEMENT la partie base64 (sans data:image/png;base64,)
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = error => reject(error);
      });
    }
    
    async function generatePresentation() {
      const prompt = document.getElementById('prompt').value.trim();
      const slides = document.getElementById('slides').value;
      const style = document.getElementById('style').value;
      
      const statusDiv = document.getElementById('status');
      const resultDiv = document.getElementById('result');
      const generateBtn = document.getElementById('generateBtn');
      const progressContainer = document.getElementById('progressContainer');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      if (!prompt && selectedFiles.length === 0) {
        showStatus('error', '‚ö†Ô∏è Veuillez entrer un prompt ou ajouter des documents');
        return;
      }
      
      // ‚úÖ CORRECTION : Envoyer le prompt TEL QUEL en fran√ßais
      // On ajoute juste les infos de style et nombre de slides
      let finalPrompt = prompt || 'Cr√©er une pr√©sentation bas√©e sur les documents fournis.';
      finalPrompt += ` Style ${style}. Cr√©er exactement ${slides} slides.`;
      
      // Afficher loading
      generateBtn.disabled = true;
      generateBtn.textContent = '‚è≥ Pr√©paration...';
      resultDiv.style.display = 'none';
      
      try {
        // Pr√©parer les fichiers en base64
        let attachments = [];
        
        if (selectedFiles.length > 0) {
          progressContainer.style.display = 'block';
          progressText.textContent = 'Pr√©paration des fichiers...';
          
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            progressText.textContent = `Traitement de ${file.name}...`;
            progressFill.style.width = ((i + 1) / selectedFiles.length * 50) + '%';
            
            const base64 = await fileToBase64(file);
            attachments.push({
              filename: file.name,
              content: base64,
              type: file.type,
              size: file.size
            });
          }
        }
        
        progressText.textContent = 'ü§ñ Envoi √† l\'IA...';
        progressFill.style.width = '60%';
        showStatus('loading', `ü§ñ G√©n√©ration en cours... ${selectedFiles.length > 0 ? `(${selectedFiles.length} document(s))` : ''}`);
        generateBtn.textContent = '‚è≥ G√©n√©ration...';
        
        // ‚úÖ CORRECTION : Payload simplifi√© pour le workflow n8n
        const payload = { 
          prompt: finalPrompt
        };
        
        // Ajouter les pi√®ces jointes si pr√©sentes
        if (attachments.length > 0) {
          payload.attachments = attachments;
        }
        
        console.log('üì§ Envoi au webhook:', payload);
        
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });
        
        progressFill.style.width = '90%';
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('üì• R√©ponse du webhook:', data);
        
        progressFill.style.width = '100%';
        progressText.textContent = '‚úÖ Termin√© !';
        
        // ‚úÖ CORRECTION : Affichage am√©lior√© du r√©sultat
        showStatus('success', '‚úÖ Pr√©sentation g√©n√©r√©e avec succ√®s !');
        resultDiv.style.display = 'block';
        
        // Afficher l'URL Gamma si disponible
        if (data.gamma_url) {
          resultDiv.innerHTML = `
            <strong>üéâ Votre pr√©sentation est pr√™te !</strong><br>
            <a href="${data.gamma_url}" target="_blank">üîó Ouvrir dans Gamma</a>
            <div class="result-details">
              <strong>ID de g√©n√©ration :</strong> ${data.generation_id || 'N/A'}<br>
              <strong>Statut :</strong> ${data.status || 'En cours'}
            </div>
          `;
        } else if (data.generationId || data.generation_id) {
          // Si on a juste le generationId mais pas encore l'URL
          const genId = data.generationId || data.generation_id;
          resultDiv.innerHTML = `
            <strong>‚è≥ G√©n√©ration en cours...</strong><br>
            <p>ID: ${genId}</p>
            <p>La pr√©sentation est en cours de cr√©ation. Vous pouvez v√©rifier son statut sur <a href="https://gamma.app" target="_blank">gamma.app</a></p>
            <div class="result-details">
              ${JSON.stringify(data, null, 2)}
            </div>
          `;
        } else {
          // Afficher la r√©ponse brute
          resultDiv.innerHTML = `
            <strong>R√©ponse de l'API :</strong>
            <div class="result-details">
              ${JSON.stringify(data, null, 2)}
            </div>
          `;
        }
        
      } catch (error) {
        console.error('‚ùå Erreur:', error);
        showStatus('error', '‚ùå Erreur : ' + error.message);
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <strong>D√©tails de l'erreur :</strong><br>
          <div class="result-details">${error.message}</div>
        `;
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = '‚ú® G√©n√©rer Pr√©sentation';
        setTimeout(() => {
          progressContainer.style.display = 'none';
          progressFill.style.width = '0%';
        }, 2000);
      }
    }
    
    function showStatus(type, message) {
      const statusDiv = document.getElementById('status');
      statusDiv.className = 'status ' + type;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
    }
    
    // Raccourci clavier : Ctrl/Cmd + Enter pour g√©n√©rer
    document.getElementById('prompt').addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        generatePresentation();
      }
    });
  </script>
</body>
</html>
